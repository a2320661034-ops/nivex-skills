# 执行步骤 — 交易所语言QA完整工作流

## 总览

6个步骤。术语表是审查基石，**必须在全量扫描之前就绪**。

```
Step 0: 确认参数 → 检查术语表是否存在
Step 1: 术语标准（无则构建，有则加载）← 必须先于扫描
Step 2: 全量扫描 → 带着术语表输出问题清单
Step 2.5: 深度语义扫描 → 引擎抓不到的语义级错译
Step 3: 人工审核 → 等待龙老师确认
Step 4: 批量修正 → 只改目标语言列
Step 5: 多轮验证 → 输出验证报告
```

---

## Step 0: 确认参数

### 输入
龙老师的QA需求

### 操作
1. 确认目标语言（越南语/韩语/日语/...）
2. 确认CSV文件路径列表（ls 目录，列出所有CSV）
3. 确认目标语言列名（如"越语"、"韩语"）
4. 检查 `~/.claude/skills/交易所语言QA/术语表/` 下是否已有该语言术语表
5. 确认源语言列名（默认"简体中文"）

### 输出
已确认的参数集

### 路由判断（铁律）
```
有术语表 → Step 1 加载 → Step 2 全量扫描
无术语表 → Step 1 构建（必须含行业对标）→ 龙老师确认 → Step 2 全量扫描
```
**阻断规则：没有术语表，禁止进入 Step 2 全量扫描。**

---

## Step 1: 术语标准（构建或加载）

### 场景A: 无术语表 → 构建（必须执行行业对标）

这是**阻断性前置步骤**。没有术语标准就没有修正依据，不允许跳过。

### 输入
所有CSV文件

### 操作（严格按序）
1. **提取高频术语**：从所有CSV中提取源语言短文本（语言标识 ≤ 8字符），统计频次，去重，按频次降序取 Top 500+
2. **行业对标（必须）**：抓取 Binance/OKX/Bybit/Gate.io 目标语言界面翻译
   - 用 WebSearch/WebFetch 搜索并抓取头部交易所目标语言界面的导航、按钮、功能模块命名
   - 对每个高频术语记录各交易所的翻译，取共识度最高的作为建议标准
   - **此步不可跳过，不可用猜测替代一手数据**
3. **生成术语对照表**：中文 → English → 行业标准翻译 → 当前翻译 → 是否一致
4. **标记需确认条目**：行业无共识、或当前翻译与建议标准有明显差异的
5. **提交龙老师确认**：龙老师确认/覆盖后固化到 `术语表/{语言名}.md`

### 输出
- 固化的术语表文件 `术语表/{语言名}.md`
- 龙老师覆盖记录

### 铁律
- **行业对标是必须步骤，不是可选步骤**
- 不确定的术语问龙老师，不猜
- 按 [规则/术语规范.md](../规则/术语规范.md) 的结构固化

### 场景B: 有术语表 → 加载

### 操作
1. 读取 `术语表/{语言名}.md`
2. 构建术语匹配字典
3. 直接进入 Step 2

---

## Step 2: 全量扫描

### 前置条件
**必须已有术语表（Step 1 完成）**。无术语表时此步骤被阻断。

### 输入
- CSV文件列表 + 目标语言列名
- 术语标准表（必须）

### 操作
1. 读取每个CSV（编码 `utf-8-sig`，`csv.DictReader`）
2. 逐行检查目标语言列，按审查规则的检测顺序执行（9项全跑）
3. 对每个问题生成**完整的修正建议**：
   - 术语不匹配 → 用标准术语替换，输出完整句子
   - 全角标点 → 全部替换半角，输出完整句子
   - 中文残留 → 用片段映射表替换，输出完整句子
   - 空/未翻译 → 建议修正留空（标记需人工翻译）
4. 按问题清单格式输出CSV

### 输出
- `{目标语言}问题清单.csv`
- 控制台摘要报告

### 验证
问题清单行数 > 0（= 0 说明质量已OK或检测有bug，需二次确认）

---

## Step 2.5: 深度语义扫描（引擎之后、人工之前）

### 为什么需要这步？
`qa_engine.py` 只做**规则匹配**（术语表、格式、标点）。但翻译错误往往是**语义级**的——引擎看不出"Cân bằng"（平衡）不是"余额"的正确翻译。这一步补上这个盲区。

### 前置条件
Step 2 引擎扫描已完成

### 操作
动态生成并执行Python扫描脚本，包含以下检测模块：

#### 模块1: 已知错译黑名单匹配
从术语表的"错误翻译黑名单"提取所有条目，逐行扫描目标语言列：
```python
WRONG_TERMS = {
    "đồng xu": "coin",           # 硬币→加密货币
    "tiền xu": "coin",           # 硬币→加密货币
    "Cân bằng": "Số dư",        # 平衡→余额（余额语境）
    "Ủy ban phát hành": "Hoa hồng Spot",  # 委员会发行→现货佣金
    "kiểm điểm": "kiểm duyệt",  # 检讨→审核
    "Chuyển khoản nội địa": "Chuyển khoản nội bộ",  # 国内→内部
    "(Tùy ngữ cảnh)": "cái",    # 注释暴露给用户
    "passsive": "thụ động",      # 拼写错误
    # ... 完整列表从术语表黑名单加载
}
```

#### 模块2: 括号内容校验（折U类问题）
扫描所有包含括号 `()` 的目标语言文本，提取括号内容，检查异常：
```python
# 检测括号内是否包含异常翻译
# 典型错误：(Fold U), (Đơn vị), (ưu đãi U), (quy đổi U), (USD)
# 正确应为：(USDT)
# 方法：提取括号内容，匹配已知错误模式
```
**关键规则**：中文"折U"、"(折U)"对应的越语必须是"(USDT)"，不接受任何创意翻译。

#### 模块3: 语境敏感错译检测
结合中文源语言列判断翻译是否正确：
```python
# 余额语境：cn含"余额" → vn不应含"Cân bằng"（应为Số dư）
# 返佣语境：cn含"返佣" → vn不应含"Giảm giá"（应为Hoàn phí）
# 净入金语境：cn含"净入金" → vn不应含"Tiền gửi thực"（应为Nạp ròng）
# 交易额语境：cn含"交易额" → vn不应含"Số lượng"（应为Khối lượng）
# 放行语境：cn含"放行/放币" → vn不应含"phát hành"（应为giải phóng）
```

#### 模块4: 残留碎片检测
- 中文字符残留（排除品牌名/占位符后）
- 英文注释残留：`(bằng tiếng En-us)` 等
- 不完整翻译碎片：`ch passive`、`Thu nhập ch` 等
- 纯英文未翻译（越语列无越南语特殊字符）

#### 模块5: 全局替换安全检查（防误伤）
**铁律**：全局文本替换必须检查语境，防止非目标语境被误改：
- `tương lai` 在非金融语境（"未来"）不改为 `Futures`
- `phát hành` 在"发行/发布"语境不改为 `giải phóng`
- 同一ID在不同文件可能是不同内容，不能跨文件套用修复

### 输出
- 深度扫描问题列表（按类型分组）
- 合并到问题清单，标记为 `SEMANTIC_ERROR` / `BRACKET_MISMATCH` / `CONTEXT_MISTRANSLATION` / `FRAGMENT_RESIDUAL`

### 修复方式
生成**精确修复脚本**，每条修复必须：
1. 指定文件+ID（不跨文件）
2. 指定匹配条件（old_contains）
3. 指定完整新值
4. 语境敏感替换需检查中文源语言列

---

## Step 3: 人工审核（必须等待龙老师确认）

### 输入
术语对照表 + 问题清单

### 操作
1. 将术语对照表中"需确认"条目提交龙老师
2. **等待龙老师逐条确认/修改**
3. 龙老师覆盖的条目更新到术语表，标记"龙老师覆盖"
4. 将确认结果固化到 `术语表/{语言名}.md`
5. 用确认后的术语重新生成问题清单

### 输出
- 确认后的术语标准表
- 更新后的问题清单

### 铁律
- **不跳过此步骤**
- **不自作主张替代龙老师决策**
- 有争议术语，问龙老师，不猜

---

## Step 4: 批量修正

### 输入
- 确认后的问题清单（含建议修正）
- CSV文件列表

### 操作
1. **创建备份**：`{原文件名}_backup_原始.csv`（已存在则跳过）
2. 读取问题清单，构建修正映射：`(来源, 编号ID) → 建议修正`
3. 逐文件处理：
   - 读取CSV
   - 对每行：如果在映射中且建议修正非空 → 替换目标语言列
   - 写回CSV（`utf-8-sig`, `QUOTE_MINIMAL`, `newline=''`）
4. 输出修改统计

### 输出
- 修改后的CSV文件（原地修改）
- 修改统计（每文件：总行数、修改数、跳过数）

### 铁律
- **只改目标语言列，绝不改其他列**
- **跳过建议修正为空的行**
- **写回时保持原文件编码和格式**

---

## Step 5: 多轮验证

### 输入
修改后的CSV文件 + 术语标准表 + 备份文件

### 操作
1. 对修改后文件重新执行 Step 1 全量扫描
2. 检查6道质量门禁
3. 执行列完整性验证V1-V4（对比备份文件）
4. 生成验证报告

### 输出
验证报告

### 路由判断
- **全部通过** → SAFE TO DEPLOY，交付龙老师
- **有残留问题** → 回到 Step 4 修复，再回 Step 5
- **列完整性失败** → 回滚到备份，排查原因

---

## 迭代规则

- Step 4 和 Step 5 可多轮迭代
- **每轮问题数必须递减**，不减反增则停下来检查修复逻辑
- 通常 2-3 轮迭代可达到零问题
- 最终验证报告 SAFE TO DEPLOY 才可交付

---

## 交付确认清单

- [ ] 验证报告结论为 SAFE TO DEPLOY
- [ ] 龙老师覆盖术语已全部应用
- [ ] 备份文件存在且可回滚
- [ ] 只有目标语言列被修改（列完整性通过）
- [ ] 龙老师确认可以发给技术团队
