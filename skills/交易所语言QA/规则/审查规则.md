# 审查规则 — 问题类型定义与检测逻辑

## 概述
所有检测规则作用于**目标语言列**。源语言列默认为"简体中文"。
规则按优先级分为 P0（致命）、P1（严重）、P2（建议）三级。

---

## P0 — 致命问题（必须修复，阻断交付）

### EMPTY — 目标语言为空
- **条件**：源语言有内容，目标语言为空或仅空白字符
- **检测**：`target.strip() == "" and source.strip() != ""`
- **处理**：标记需人工翻译，建议修正留空

### UNTRANSLATED_COPY — 未翻译（原样复制）
- **条件**：目标语言与源语言完全相同，且源语言包含中文字符
- **检测**：`target.strip() == source.strip() and has_chinese(source)`
- **处理**：标记需完整翻译

### CONTAINS_CHINESE — 中文残留
- **条件**：目标语言中包含中文字符（Unicode范围 \u4e00-\u9fff, \u3400-\u4dbf）
- **检测**：`re.search(r'[\u4e00-\u9fff\u3400-\u4dbf]', target)`
- **排除**：源语言本身无中文的行不检查此项
- **处理**：
  - 已知中文片段 → 查片段映射表自动替换，输出完整修正句
  - 未知片段 → 标记需人工处理，尽量输出完整修正建议

### CHINESE_FRAGMENT — 中文片段残留
- **条件**：CONTAINS_CHINESE 的子类，目标语言大部分是目标语言文字，但夹杂个别中文词
- **检测**：中文字符占比 < 50%，但 > 0
- **处理**：用片段映射表替换已知片段，输出完整修正句

### MOJIBAKE — 编码损坏
- **条件**：目标语言包含 UTF-8 双重编码特征
- **检测**：匹配 `Ã¡|Ã©|Ã³|â€|áº|á»|Ã¢|Ã´|Æ°|Ä` 等模式
- **处理**：标记需人工检查，尝试 UTF-8→Latin1→UTF-8 解码修复

---

## P1 — 严重问题（应修复）

### FULLWIDTH_PUNCTUATION — 全角标点
- **条件**：目标语言使用了中日韩全角标点
- **检测**：匹配以下字符
- **映射表（语言无关）**：

| 全角 | 半角 | 说明 |
|------|------|------|
| ， | , | 逗号 |
| ！ | ! | 感叹号 |
| ？ | ? | 问号 |
| ： | : | 冒号 |
| ； | ; | 分号 |
| （ | ( | 左括号 |
| ） | ) | 右括号 |
| 【 | [ | 左方括号 |
| 】 | ] | 右方括号 |
| " | " | 左双引号 |
| " | " | 右双引号 |
| ' | ' | 左单引号 |
| ' | ' | 右单引号 |
| ～ | ~ | 波浪号 |
| … | ... | 省略号 |
| — | - | 破折号 |
| 、 | , | 顿号→逗号 |
| 。 | . | 句号→点号 |
| 《 | < | 书名号 |
| 》 | > | 书名号 |
| 丨 | \| | 竖线 |

- **处理**：自动替换为半角，输出完整修正句

### WRONG_TERM — 禁止术语残留（v2.0新增）
- **条件**：目标语言包含术语表中明确禁止的越南语用法
- **检测**：扫描目标语言列，匹配以下禁止词（需结合中文源语境判断）：
  - `Hợp đồng tương lai` → 应为 Futures
  - `Giao ngay` / `giao ngay` → 应为 Spot（中文含"现货"时）
  - `Sao chép giao dịch` / `Giao dịch sao chép` → 应为 Copy Trade
  - `Nhà giao dịch`（非OTC语境）→ 应为 Trader
  - `rebate` / `hoa hồng ngược` → 应为 Hoàn phí
  - `Đơn hàng`（交易语境）→ 应为 Lệnh
  - `Giá thị trường`（市价语境）→ 应为 Giá Market
  - `Giá giới hạn`（限价语境）→ 应为 Giá Limit
  - `Mở cửa` / `Đóng cửa`（仓位语境）→ 应为 Mở/Đóng vị thế
  - `sức mạnh băm` → 应为 sức mạnh tính toán
  - `Kết Thúc Sớm?` → 应为 Có kết thúc trước thời hạn không?
- **语境判断**：必须读取中文源语言列判断上下文，详见术语表"语境判断规则"
- **处理**：自动替换为标准术语，输出完整修正句
- **优先级**：P1，在 TERMINOLOGY_MISMATCH 之前执行

### TERMINOLOGY_MISMATCH — 术语不一致
- **条件**：目标语言翻译与术语标准表不匹配
- **检测**：
  1. 用语言标识列精确匹配术语表
  2. 用源语言短文本（≤8字符）精确匹配术语表
  3. 匹配成功但 target ≠ 标准翻译
- **处理**：替换为标准术语，输出完整修正句

### INCONSISTENCY — 同术语多种翻译（统一性）
- **条件**：相同的源语言文本，在不同行有不同的目标语言翻译
- **检测**：聚合同一源文本的所有目标翻译，检查是否统一
- **处理**：统一为术语表标准翻译或频率最高的翻译
- **铁律**：同一术语只允许一种翻译，不允许多变体并存
- **示例**：反佣 → rebate / hoàn phí / hoa hồng ngược（❌ 不允许，必须统一为 Hoàn phí）

### INCOMPLETE_TRANSLATION — 翻译不完整/缩略
- **条件**：目标语言只翻译了部分含义，丢失了原文的关键信息
- **检测**：目标文本词数远低于源文本对应比例（短文本排除）
- **处理**：补全翻译，输出完整修正句
- **示例**：添加首评 → "Bình luận"（❌），应为 "Thêm bình luận đầu tiên"（✅）

---

### SEMANTIC_ERROR — 语义级错译（Step 2.5 深度扫描检测）
- **条件**：目标语言语义与源语言不匹配，但格式/术语规则无法捕获
- **检测**：术语表"错误翻译黑名单"全量匹配 + 语境敏感检查
- **典型案例**：
  - "余额" → "Cân bằng"（平衡）❌ 应为 "Số dư" ✅
  - "返佣" → "Giảm giá"（打折）❌ 应为 "Hoàn phí" ✅
  - "现货佣金" → "Ủy ban phát hành"（委员会发行）❌ 应为 "Hoa hồng Spot" ✅
  - "审核" → "kiểm điểm"（检讨）❌ 应为 "kiểm duyệt" ✅
- **处理**：自动替换为正确翻译，需结合中文源语言列判断语境

### BRACKET_MISMATCH — 括号内容异常（Step 2.5 深度扫描检测）
- **条件**：括号内翻译与源语言括号内含义不匹配
- **检测**：提取括号内容，匹配已知错误模式
- **典型案例**（折U问题）：
  - "(折U)" → "(Fold U)" ❌ → "(USDT)" ✅
  - "(折U)" → "(Đơn vị)" ❌ → "(USDT)" ✅
  - "(折U)" → "(USD)" ❌ → "(USDT)" ✅
  - "(折U)" → "(ưu đãi U)" ❌ → "(USDT)" ✅
  - "(折U)" → "(quy đổi U)" ❌ → "(USDT)" ✅
- **铁律**："折U"只有一种正确翻译：(USDT)

### CONTEXT_MISTRANSLATION — 上下文错译（Step 2.5 深度扫描检测）
- **条件**：翻译在脱离语境时看似合理，但在当前中文语境下错误
- **检测**：读取中文源语言列，判断词义选择是否正确
- **典型案例**：
  - "内部转账" → "Chuyển khoản nội địa"（国内转账）❌ 应为 "nội bộ"（内部）✅
  - "放行" → "phát hành"（发行）❌ 应为 "giải phóng"（释放）✅
  - "交易额" → "Số lượng giao dịch"（交易数量）❌ 应为 "Khối lượng"（交易量）✅
- **处理**：语境判断后替换，需格外小心同一词在不同语境含义不同

### FRAGMENT_RESIDUAL — 残留碎片（Step 2.5 深度扫描检测）
- **条件**：翻译中残留注释、不完整英文、或暴露给用户的内部标记
- **检测**：正则匹配已知碎片模式
- **典型案例**：
  - "(Tùy ngữ cảnh)" — 内部注释暴露给用户
  - "(bằng tiếng En-us)" — 语言注释残留
  - "ch passive" — 不完整英文碎片
  - "passsive" — 拼写错误残留
- **处理**：删除或替换为正确文本

---

## P2 — 建议改进

### WHITESPACE — 多余空白
- **条件**：前后多余空格、连续双空格
- **处理**：自动修剪

### CAPITALIZATION — 越南语大小写规范
- **条件**：句首未大写，或句号后下一个字母未大写
- **检测**：检测越南语文本中的大小写规范
- **处理**：自动修正大小写
- **规则**：越南语遵循专业文书规范——句首大写、标点后大写
- **例外（不大写）**：
  - 数字后时间单位：`1 ngày`✅ `1 Ngày`❌ / `30 phút`✅ `30 Phút`❌
  - 多行文本续行：`\n` 后若语义连续，不强制大写
  - 小写介词/助词在句中：`của`, `và`, `hoặc` 等保持小写

### BROKEN_HTML — HTML标签损坏
- **条件**：包含未闭合或多余的HTML标签（`<br`, `<b>` 无 `</b>` 等）
- **处理**：标记人工检查

---

## 检测顺序（严格执行）

```
=== Step 2: 引擎扫描（qa_engine.py）===
1. EMPTY
2. UNTRANSLATED_COPY
3. CONTAINS_CHINESE / CHINESE_FRAGMENT
4. MOJIBAKE
5. FULLWIDTH_PUNCTUATION
6. WRONG_TERM（禁止术语扫描 — 需语境判断）
7. TERMINOLOGY_MISMATCH
8. INCONSISTENCY（同术语统一性）
9. INCOMPLETE_TRANSLATION（翻译完整性）
10. WHITESPACE
11. CAPITALIZATION（大小写规范 — 注意时间单位例外）
12. BROKEN_HTML

=== Step 2.5: 深度语义扫描（Python脚本）===
13. SEMANTIC_ERROR（已知错译黑名单匹配）
14. BRACKET_MISMATCH（括号内容异常，如折U）
15. CONTEXT_MISTRANSLATION（语境敏感错译）
16. FRAGMENT_RESIDUAL（残留碎片/注释/拼写错误）
```

**短路规则**：命中 EMPTY 或 UNTRANSLATED_COPY 后，跳过后续检测（整个值需要重写）。

---

## 中文字符检测函数

```python
import re
RE_CHINESE = re.compile(r'[\u4e00-\u9fff\u3400-\u4dbf]')

def has_chinese(text):
    return bool(RE_CHINESE.search(text))

def extract_chinese(text):
    return RE_CHINESE.findall(text)

def chinese_ratio(text):
    if not text: return 0
    cn = len(RE_CHINESE.findall(text))
    return cn / len(text)
```

---

## 全局替换安全规则（血泪教训）

### 铁律：不做盲目全局替换
以下错误在实战中已发生，必须避免：

1. **同一词多义，语境不同不能统一替换**
   - `tương lai`（未来）：金融语境→Futures ✅ | "财富未来"→不改 ✅
   - `phát hành`（发行）：放行语境→giải phóng ✅ | 发布语境→保持 ✅

2. **同一ID在不同文件是不同内容**
   - ID 3382 在Web是"充币记录"，在代理后台是"累计净入金(折U)"
   - ID-based修复必须指定文件，不能跨文件套用

3. **替换后要检查残留前缀**
   - "Sự cân bằng" 替换 "cân bằng→số dư" 后变成 "Sự số dư"（错）
   - 应整体替换 "Sự cân bằng" → "Số dư"

4. **修复脚本结构要求**
   ```python
   # 正确：指定文件+ID+匹配条件
   fix_file("代理后台.csv", [
       ("3870", "(On-Chain)", "Hashrate (USDT)"),  # 指定文件、ID、匹配
   ])

   # 错误：全局正则替换不检查语境
   vn = vn.replace("tương lai", "Futures")  # 会误伤非金融语境
   ```

---

## 修正输出要求
**所有建议修正必须是完整的目标语言文本**，不是提示片段。

- 正确：`Số tiền tích lũy | Số kỳ`
- 错误：`「丨」应替换为「|」`
- 正确：`Chỉ mang tính tham khảo, không cấu thành cam kết lợi nhuận`
- 错误：`【需人工翻译】将「供参考」替换为 mang tính tham khảo`
